<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mercari2Neokyo</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
        crossorigin="anonymous"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    >
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Преобразователь ссылок на Mercari в ссылки на Neokyo</h5>

            <form id="inputForm">
                <div class="mb-3">
                    <label for="url" class="form-label">Ссылки на Mercari:</label>
                    <textarea id="url" class="form-control" rows="10"></textarea>
                    <div id="urlHelp" class="form-text">
                        Вставьте ссылку или несколько ссылок, каждую с новой строки
                    </div>
                </div>
                <input type="submit" value="Конвертировать" class="btn btn-primary">
            </form>

            <ul class="list-group mt-4" id="resultList"></ul>
        </div>
    </div>
</div>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"
></script>
<script>
    function reliableCopying(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
        } else {
            const div = document.createElement("div");
            div.innerText = text;
            div.style.position = "fixed";
            div.style.opacity = "0";
            document.body.append(div);
            const range = new Range();
            range.setStart(div, 0);
            range.setEnd(div, 1);
            document.getSelection().removeAllRanges();
            document.getSelection().addRange(range);
            document.execCommand("copy");
            div.remove();
        }
    }
</script>
<script>
    const form = document.getElementById('inputForm');
    const input = document.getElementById('url');
    let resultList = document.getElementById('resultList');

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        const textFieldValue = input.value;

        resultList.textContent = '';

        for (let line of textFieldValue.split(/\n/g)) {
            if (!line) {
                continue;
            }

            let sourceUrl;
            let resultUrl = null;

            try {
                sourceUrl = new URL(line);
            }
            catch (error) {
                console.warn(`"${line}" is not a valid URL`);
            }

            if (sourceUrl && sourceUrl.hostname === 'neokyo.com') {
                // Уже neokyo, ничего преобразовывать не надо
                resultUrl = sourceUrl;
            }
            else if (sourceUrl && sourceUrl.hostname === 'jp.mercari.com') {
                const matches = /m\d{11}/.exec(sourceUrl.pathname);

                if (matches && matches.length === 1) {
                    resultUrl = new URL(matches[0], 'https://neokyo.com/en/product/mercari/').toString();
                }
            }

            let listElement = document.createElement('li');

            if (resultUrl) {
                listElement.className = 'list-group-item d-flex justify-content-between align-items-start';

                let listElementBlock = document.createElement('div');
                listElementBlock.className = 'ms-2 me-auto';

                let link = document.createElement('a');
                link.href = resultUrl
                link.textContent = resultUrl;

                listElementBlock.appendChild(link);
                listElement.appendChild(listElementBlock);

                let copyIcon = document.createElement('a');
                copyIcon.className = 'bi bi-copy';
                copyIcon.setAttribute('role', 'button');
                copyIcon.setAttribute('tabindex', '0');
                copyIcon.setAttribute('data-bs-container', 'body');
                copyIcon.setAttribute('data-bs-toggle', 'popover');
                copyIcon.setAttribute('data-bs-trigger', 'focus');
                copyIcon.setAttribute('data-bs-placement', 'left');
                copyIcon.setAttribute('data-bs-content', 'Скопировано!');
                new bootstrap.Popover(copyIcon, {
                    trigger: 'focus'
                });

                copyIcon.addEventListener('click', (event) => {
                    reliableCopying(resultUrl);
                });

                listElement.appendChild(copyIcon);
            }
            else {
                listElement.className = 'list-group-item list-group-item-danger d-flex justify-content-between align-items-start';
                listElement.textContent = 'Невалидная ссылка на товар Mercari'
            }

            resultList.appendChild(listElement);
        }
    });
</script>
</body>
</html>

